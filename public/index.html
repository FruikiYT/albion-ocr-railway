<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Awakening Calculator Albion</title>
  <link href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
  <style>
    body { font-family:sans-serif; background:#f0f2f5; margin:0; padding:2rem; display:flex; justify-content:center; }
    .container { max-width:600px; width:100%; background:#fff; padding:1rem; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h1 { text-align:center; margin-bottom:1rem; }
    #drop-zone { border:2px dashed #666; padding:1rem; text-align:center; cursor:pointer; }
    #image { max-width:100%; display:none; margin-top:1rem; }
    #crop-btn, #ocr-btn { margin-top:1rem; padding:0.5rem 1rem; }
    .fields { margin-top:1rem; }
    .fields label { display:block; margin-top:0.5rem; }
    .fields input { width:100%; padding:0.5rem; margin-top:0.25rem; }
    #result { margin-top:1rem; background:#eef; padding:1rem; white-space:pre-wrap; }
    .footer { text-align:center; margin-top:1rem; color:#666; font-size:0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Awakening Calculator</h1>
    <div id="drop-zone">Glisse ton image ici ou clique</div>
    <img id="image" />
    <button id="crop-btn" style="display:none;">Sélectionner zone statistiques et recadrer</button>
    <button id="ocr-btn" style="display:none;">Analyser le crop (IA)</button>
    <div class="fields">
      <label>Harmonisation : <input id="harm" type="number"/></label>
      <label>Tension (%) : <input id="tension" type="number" step="0.01"/></label>
      <label>Valeur légendaire : <input id="legend" type="number"/></label>
      <button id="calc-btn" style="margin-top:1rem;">Calculer</button>
    </div>
    <div id="result"></div>
    <div class="footer">Créé par : Fruiknox</div>
  </div>

  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script>
    const drop = document.getElementById('drop-zone');
    const img = document.getElementById('image');
    const cropBtn = document.getElementById('crop-btn');
    const ocrBtn = document.getElementById('ocr-btn');
    let cropper, blob;

    // file input hack
    const fileInput = document.createElement('input');
    fileInput.type = 'file'; fileInput.accept = 'image/*';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    drop.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', ()=> handleFile(fileInput.files[0]));

    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#eee'; });
    drop.addEventListener('dragleave', ()=>drop.style.background='');
    drop.addEventListener('drop', e=>{ e.preventDefault(); drop.style.background=''; handleFile(e.dataTransfer.files[0]); });

    function handleFile(file) {
      img.src = URL.createObjectURL(file);
      img.style.display = 'block';
      drop.style.display = 'none';
      cropBtn.style.display = 'inline-block';
      ocrBtn.style.display = 'none';
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, { viewMode:1, autoCrop:false });
    }

    cropBtn.addEventListener('click', () => {
      const canvas = cropper.getCroppedCanvas();
      canvas.toBlob(b => {
        blob = b;
        // preview the crop
        img.src = URL.createObjectURL(blob);
        cropper.destroy();
        cropper = null;
        ocrBtn.style.display = 'inline-block';
        cropBtn.style.display = 'none';
      });
    });

    ocrBtn.addEventListener('click', async () => {
      document.getElementById('result').innerText = 'Analyse IA en cours…';
      const fd = new FormData();
      fd.append('image', blob, 'crop.png');
      try {
        const res = await fetch('/extract-stats', { method:'POST', body:fd });
        const json = await res.json();
        if (json.error) throw new Error(json.error);
        document.getElementById('harm').value = json.harmonisation;
        document.getElementById('tension').value = json.tension;
        document.getElementById('legend').value = json.legendary;
        document.getElementById('calc-btn').click();
      } catch (e) {
        document.getElementById('result').innerText = 'Erreur OCR IA : ' + e.message;
      }
    });

    document.getElementById('calc-btn').addEventListener('click', () => {
      const h = +document.getElementById('harm').value;
      const t = +document.getElementById('tension').value;
      const l = +document.getElementById('legend').value;
      if (!h||!t||!l) return document.getElementById('result').innerText = 'Remplis tout.';
      const abs=(t/100)*h/l, sil=h*34;
      document.getElementById('result').innerText=
        `Coût abstrait : ${abs.toFixed(2)} unités\nCoût estimé : ${sil.toLocaleString()} silver`;
    });
  </script>
</body>
</html>
